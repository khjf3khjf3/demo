# Gradle
# Build your Java project and run tests with Gradle using a Gradle wrapper script.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
- master

pool:
  name: selfhost


steps:
  - script: chmod +x gradlew
    displayName: 'Grant execute permission to gradlew hahaha'

  - script: ./gradlew build
    displayName: 'Build on RHEL self-hosted agent'
    env:
      GHCR_USERNAME: $(GHCR_USERNAME)
      GHCR_TOKEN: $(GHCR_TOKEN)

  - script: |
      ./gradlew jib \
        -Djib.to.image=ghcr.io/$GHCR_USERNAME/$IMAGE_NAME:latest \
        -Djib.to.auth.username=$GHCR_USERNAME \
        -Djib.to.auth.password=$GHCR_TOKEN
    displayName: 'Jib: Push image to GitHub Container Registry'
    env:
      GHCR_USERNAME: $(GHCR_USERNAME)
      GHCR_TOKEN: $(GHCR_TOKEN)

