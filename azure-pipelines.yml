# Gradle
# Build your Java project and run tests with Gradle using a Gradle wrapper script.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
- master

pool:
  name: selfhost

variables:
- group: demo

steps:
  - script: echo "GHCR_USERNAME=$GHCR_USERNAME"
    displayName: 'ðŸ” í™˜ê²½ë³€ìˆ˜ í™•ì¸'
    env:
      GHCR_USERNAME: $(GHCR_USERNAME)

  - task: Gradle@3
    displayName: 'ðŸ› ï¸ Build with Gradle'
    inputs:
      gradleWrapperFile: 'gradlew'
      tasks: build
      options: '--debug'
      publishJUnitResults: false
      javaHomeOption: 'Path'
      jdkDirectory: '/usr/lib/jvm/java-17-openjdk'
      jdkArchitectureOption: 'x64'
    env:
      GHCR_USERNAME: $(GHCR_USERNAME)
      GHCR_TOKEN: $(GHCR_TOKEN)

  - task: Gradle@3
    displayName: 'ðŸ“¦ Jib: Push Docker image to GHCR'
    inputs:
      gradleWrapperFile: 'gradlew'
      tasks: >
        jib -Djib.to.image=ghcr.io/$GHCR_USERNAME/demo:latest
             -Djib.to.auth.username=$GHCR_USERNAME
             -Djib.to.auth.password=$GHCR_TOKEN
      options: ''
      javaHomeOption: 'Path'
      jdkDirectory: '/usr/lib/jvm/java-17-openjdk'
      jdkArchitectureOption: 'x64'
    env:
      GHCR_USERNAME: $(GHCR_USERNAME)
      GHCR_TOKEN: $(GHCR_TOKEN)

